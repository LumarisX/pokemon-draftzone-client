<div class="widget-container">
  <div class="widget-header">
    <div class="widget-label">Teambuilder</div>
    <div class="widget-options"></div>
  </div>
  <div class="widget-body">
    <div class="teambuilder__tabs">
      @for (pokemon of team; track $index) {
        <div
          class="teambuilder__tab teambuilder__tab--pokemon"
          role="button"
          tabindex="0"
          aria-selected="{{ tab === $index }}"
          [class.active]="tab === $index"
          (click)="selectTab($index, $event)"
          (keydown.enter)="selectTab($index, $event)"
          (keydown.space)="selectTab($index, $event)"
        >
          <div class="teambuilder__sprite-wrapper">
            <pdz-sprite size="3rem" [pokemon]="pokemon" />
          </div>
        </div>
      }
      <div
        class="teambuilder__tab teambuilder__tab--add"
        role="button"
        tabindex="0"
        aria-selected="{{ tab === null }}"
        [class.active]="tab === null"
        (click)="selectTab(null, $event)"
        (keydown.enter)="selectTab(null, $event)"
        (keydown.space)="selectTab(null, $event)"
      >
        +
      </div>
    </div>
    <div class="teambuilder__main">
      @if (tab == null || !team[tab]) {
        <div class="teambuilder__add-header">
          <h2>Add new Pokemon</h2>
        </div>
        <div class="teambuilder__options">
          @for (pokemon of matchupData.summary[0].team; track $index) {
            <button
              class="teambuilder__pokemon-option"
              [disabled]="isPokemonInTeam(pokemon)"
              (click)="addPokemonToTeamAndSelect(pokemon)"
              [attr.aria-label]="'Add ' + pokemon.name + ' to team'"
            >
              <div class="teambuilder__sprite-wrapper">
                <pdz-sprite [pokemon]="pokemon" />
              </div>
              <span class="teambuilder__pokemon-name">{{ pokemon.name }}</span>
            </button>
          }
        </div>
      } @else {
        @let pokemon = team[tab];
        <div
          class="teambuilder__view-tabs"
          role="tablist"
          aria-label="Pokemon view tabs"
        >
          <div
            class="teambuilder__view-tab teambuilder__view-tab--details"
            role="tab"
            tabindex="0"
            [attr.aria-selected]="view === 'details'"
            [class.active]="view === 'details'"
            (click)="selectView('details', $event)"
            (keydown.enter)="selectView('details', $event)"
            (keydown.space)="selectView('details', $event)"
          >
            Details
          </div>
          <div
            class="teambuilder__view-tab teambuilder__view-tab--moves"
            role="tab"
            tabindex="0"
            [attr.aria-selected]="view === 'moves'"
            [class.active]="view === 'moves'"
            (click)="selectMoveView($event)"
            (keydown.enter)="selectMoveView($event)"
            (keydown.space)="selectMoveView($event)"
          >
            Moves
          </div>
          <div
            class="teambuilder__view-tab teambuilder__view-tab--stats"
            role="tab"
            tabindex="0"
            [attr.aria-selected]="view === 'stats'"
            [class.active]="view === 'stats'"
            (click)="selectView('stats', $event)"
            (keydown.enter)="selectView('stats', $event)"
            (keydown.space)="selectView('stats', $event)"
          >
            Stats
          </div>
          <div
            class="teambuilder__view-tab teambuilder__view-tab--stats"
            role="tab"
            tabindex="0"
            [attr.aria-selected]="view === 'roles'"
            [class.active]="view === 'roles'"
            (click)="selectView('roles', $event)"
            (keydown.enter)="selectView('roles', $event)"
            (keydown.space)="selectView('roles', $event)"
          >
            Roles
          </div>
          <div
            class="teambuilder__view-tab teambuilder__view-tab--stats"
            role="tab"
            tabindex="0"
            [attr.aria-selected]="view === 'calcs'"
            [class.active]="view === 'calcs'"
            (click)="selectView('calcs', $event)"
            (keydown.enter)="selectView('calcs', $event)"
            (keydown.space)="selectView('calcs', $event)"
          >
            Calcs
          </div>
        </div>
        @switch (view) {
          @case ("details") {
            <div class="teambuilder__view teambuilder__view--details">
              <div class="teambuilder__section teambuilder__section--nickname">
                <label for="nickname">Nickname</label>
                <input
                  id="nickname"
                  type="text"
                  class="input input-nickname"
                  [(ngModel)]="pokemon.nickname"
                  placeholder="Enter nickname"
                />
              </div>
              <div
                class="teambuilder__section teambuilder__section--inline-group"
              >
                <div class="teambuilder__section teambuilder__section--shiny">
                  <label for="shiny">Shiny</label>
                  <input
                    id="shiny"
                    type="checkbox"
                    class="input input-shiny"
                    [(ngModel)]="pokemon.shiny"
                  />
                </div>
                <pdz-animated-selector
                  [options]="getGenderOptions(pokemon)"
                  [selected]="pokemon.gender"
                  label="Gender"
                  direction="horizontal"
                  [(ngModel)]="pokemon.gender"
                />
                <div class="input-group">
                  <label for="level" class="input-label">Level</label>
                  <input
                    id="level"
                    type="number"
                    class="input input-level"
                    max="100"
                    min="1"
                    [(ngModel)]="pokemon.level"
                    placeholder="Enter level"
                  />
                </div>
                <pdz-animated-selector
                  [options]="[255, 0]"
                  [selected]="pokemon.happiness"
                  [label]="'Happiness'"
                  direction="horizontal"
                  [(ngModel)]="pokemon.happiness"
                />
              </div>
              <div class="teambuilder__section teambuilder__dropdowns">
                <div
                  class="teambuilder__dropdown teambuilder__dropdown--tera"
                  [class.open]="openDropdown === 'tera'"
                  (click)="toggleDropdown('tera', $event)"
                  tabindex="0"
                  role="button"
                  aria-haspopup="listbox"
                >
                  <label for="tera" class="dropdown-label-text">Tera</label>
                  <div class="dropdown-control" #teraControl>
                    @if (pokemon.teraType) {
                      <img
                        [src]="getTeraIcon(pokemon.teraType)"
                        class="dropdown-icon"
                        width="20"
                        height="20"
                        [alt]="pokemon.teraType + ' icon'"
                      />
                    }
                    <span class="dropdown-label">{{
                      pokemon.teraType || "Select Tera"
                    }}</span>
                    <span class="dropdown-arrow" aria-hidden="true">▾</span>
                  </div>

                  @if (openDropdown === "tera") {
                    <ul class="dropdown-list" role="listbox">
                      @for (type of pokemon.teraTypes; track type) {
                        <li
                          class="dropdown-item"
                          role="option"
                          (click)="selectTeraType(type, $event)"
                        >
                          <img
                            [src]="getTeraIcon(type)"
                            class="dropdown-item-icon"
                            width="20"
                            height="20"
                            [alt]="type + ' icon'"
                          />
                          <span class="dropdown-item-label">{{ type }}</span>
                        </li>
                      }
                    </ul>
                  }
                </div>
                <div
                  class="teambuilder__dropdown teambuilder__dropdown--items"
                  [class.open]="openDropdown === 'item'"
                  (click)="toggleDropdown('item', $event)"
                  tabindex="0"
                  role="button"
                  aria-haspopup="listbox"
                >
                  <label for="item" class="dropdown-label-text">Item</label>
                  <div class="dropdown-control">
                    @if (getSelectedItem(); as selectedItem) {
                      <img
                        [src]="getItemIcon(selectedItem.pngId)"
                        class="dropdown-icon"
                        width="20"
                        height="20"
                        [alt]="selectedItem.name + ' icon'"
                      />
                    }
                    <span class="dropdown-label">{{
                      pokemon.item || "Select Item"
                    }}</span>
                    <span class="dropdown-arrow" aria-hidden="true">▾</span>
                  </div>

                  @if (openDropdown === "item") {
                    <div class="dropdown-list" role="listbox">
                      <div class="dropdown-search">
                        <input
                          type="text"
                          placeholder="Search items..."
                          [(ngModel)]="itemSearchQuery"
                          (ngModelChange)="filterItems()"
                          (click)="$event.stopPropagation()"
                        />
                        <button>X</button>
                      </div>

                      @if (filteredItems.length === 0) {
                        <div class="dropdown-empty">No items found</div>
                      } @else {
                        <ul class="dropdown-items-list">
                          @for (item of filteredItems; track item.id) {
                            <li
                              class="dropdown-item"
                              [class.selected]="item.name === pokemon.item"
                              role="option"
                              (click)="selectItem(item.name, $event)"
                            >
                              <img
                                [src]="getItemIcon(item.pngId)"
                                class="dropdown-item-icon"
                                width="20"
                                height="20"
                                [alt]="item.name + ' icon'"
                              />
                              <span class="dropdown-item-label">{{
                                item.name
                              }}</span>
                            </li>
                          }
                        </ul>
                      }
                    </div>
                  }
                </div>
                <div
                  class="teambuilder__dropdown teambuilder__dropdown--ability"
                  [class.open]="openDropdown === 'ability'"
                  (click)="toggleDropdown('ability', $event)"
                  tabindex="0"
                  role="button"
                  aria-haspopup="listbox"
                >
                  <label for="ability" class="dropdown-label-text"
                    >Ability</label
                  >
                  <div class="dropdown-control" #abilityControl>
                    <span class="dropdown-label">{{
                      pokemon.ability || "Select Ability"
                    }}</span>
                    <span class="dropdown-arrow" aria-hidden="true">▾</span>
                  </div>

                  @if (openDropdown === "ability") {
                    <ul class="dropdown-list" role="listbox">
                      @for (ability of pokemon.abilities; track ability) {
                        <li
                          class="dropdown-item"
                          role="option"
                          (click)="selectAbility(ability, $event)"
                        >
                          <span class="dropdown-item-label">{{ ability }}</span>
                        </li>
                      }
                    </ul>
                  }
                </div>
              </div>
              <div
                class="teambuilder__section teambuilder__section--ability-new"
              >
                <label class="section-label">Ability (New Selector)</label>
                <pdz-animated-selector
                  [options]="pokemon.abilities"
                  [selected]="pokemon.ability"
                  label="Ability"
                  [(ngModel)]="pokemon.ability"
                />
              </div>
              <div class="teambuilder__section teambuilder__section--export">
                <textarea
                  spellcheck="false"
                  [value]="pokemon.export()"
                ></textarea>
              </div>
            </div>
          }
          @case ("moves") {
            <div class="teambuilder__view">
              <div
                class="teambuilder__section teambuilder__moves moves-container"
              >
                <h2>Moves</h2>
                <div class="moves-list">
                  @for (moveSlot of [0, 1, 2, 3]; track moveSlot) {
                    <button
                      class="teambuilder__button teambuilder__button--moves"
                      [class.selected]="selectedMove === moveSlot"
                      [class.set]="pokemon.moves[moveSlot]"
                      [style.background]="
                        typeColor(pokemon.moves[moveSlot]?.type)
                      "
                      (click)="selectedMove = moveSlot"
                    >
                      {{ pokemon.moves[moveSlot]?.name || "Select Move" }}
                    </button>
                  }
                </div>
                <div class="dropdown-list" role="listbox">
                  <div class="table-search">
                    <input
                      type="text"
                      placeholder="Search moves..."
                      [(ngModel)]="moveSearchQuery"
                      (ngModelChange)="filterMoves()"
                      (click)="$event.stopPropagation()"
                    />
                    <button (click)="selectMove(selectedMove, null, $event)">
                      ✕
                    </button>
                  </div>
                  @if (filteredMoves === null) {
                    <pdz-loading></pdz-loading>
                  } @else if (filteredMoves.length === 0) {
                    <div class="dropdown-empty">No moves found</div>
                  } @else {
                    <div class="dropdown-table-header">
                      <span
                        class="dropdown-table-header-col"
                        [class.sorted]="sortColumn === 'type'"
                        (click)="sortByColumn('type')"
                        role="button"
                        tabindex="0"
                        >Type</span
                      >
                      <span class="dropdown-table-header-col"></span>
                      <span
                        class="dropdown-table-header-col"
                        [class.sorted]="sortColumn === 'name'"
                        (click)="sortByColumn('name')"
                        role="button"
                        tabindex="0"
                        >Move</span
                      >
                      <span class="dropdown-table-header-col" tabindex="0"
                        >Description</span
                      >
                      <span
                        class="dropdown-table-header-col"
                        [class.sorted]="sortColumn === 'power'"
                        (click)="sortByColumn('power')"
                        role="button"
                        tabindex="0"
                        >Power</span
                      >
                      <span
                        class="dropdown-table-header-col"
                        [class.sorted]="sortColumn === 'accuracy'"
                        (click)="sortByColumn('accuracy')"
                        role="button"
                        tabindex="0"
                        >Acc.</span
                      >
                      <span
                        class="dropdown-table-header-col"
                        [class.sorted]="sortColumn === 'strength'"
                        (click)="sortByColumn('strength')"
                        role="button"
                        tabindex="0"
                        >Strength</span
                      >
                    </div>
                    <ul class="dropdown-items-list">
                      @for (move of filteredMoves; track move.id) {
                        <li
                          class="dropdown-item"
                          [class.selected]="isMoveSelected(move)"
                          [class.stab]="move.isStab"
                          role="option"
                          (click)="selectMove(selectedMove, move, $event)"
                        >
                          <div class="type-container">
                            <div
                              class="type-label"
                              [style.background]="typeColor(move.type)"
                            >
                              <div class="type-text">
                                {{ move.type }}
                              </div>
                            </div>
                          </div>
                          <img [src]="categoryIcon(move.category)" />
                          <span class="dropdown-item-label">{{
                            move.name
                          }}</span>
                          <span class="dropdown-item-label">{{
                            move.desc
                          }}</span>
                          <span class="dropdown-item-label">{{
                            move.basePower +
                              (move.modified?.basePower ? "*" : "")
                          }}</span>
                          <span class="dropdown-item-label">{{
                            move.accuracy + (move.modified?.accuracy ? "*" : "")
                          }}</span>
                          <span class="dropdown-item-label">{{
                            move.strength | number: "1.0-1"
                          }}</span>
                        </li>
                      }
                    </ul>
                  }
                </div>
              </div>
              <div class="teambuilder__section teambuilder__coverage">
                <h2>Coverage</h2>
                <div class="coverage-list">
                  @for (
                    pokemon of matchupData.typechart[1].team;
                    track pokemon.id
                  ) {
                    <div
                      class="teambuilder__sprite-wrapper"
                      [style.background-color]="
                        getCoverageEffectiveness(pokemon)
                      "
                    >
                      <pdz-sprite size="3rem" [pokemon]="pokemon" />
                    </div>
                  }
                </div>
              </div>
            </div>
          }
          @case ("stats") {
            <div class="teambuilder__view">
              <div
                class="teambuilder__section teambuilder__stats stats-container"
              >
                @for (stat of STATS; track stat) {
                  <div class="stat">
                    <div class="stat-header">
                      <label [for]="'stat-' + $index" class="stat-label">
                        {{ stat.full }}
                      </label>
                      <div class="stat-base">
                        <span class="base-label">Base</span>
                        <span
                          class="base-value"
                          [style.background-color]="
                            statColor(pokemon.stats[stat.id].base)
                          "
                          >{{ pokemon.stats[stat.id].base }}</span
                        >
                      </div>
                    </div>
                    <div class="stat-slider-row">
                      <input
                        [id]="'stat-' + $index"
                        type="range"
                        [style.accent-color]="getSliderColor(stat.id)"
                        [min]="pokemon.stats[stat.id].min()"
                        [max]="pokemon.stats[stat.id].max()"
                        class="slider slider-stat"
                        [ngModel]="pokemon.stats[stat.id].get()"
                        (ngModelChange)="pokemon.stats[stat.id].set($event)"
                      />
                      <input
                        class="input input-stat"
                        [id]="'stat-' + $index"
                        type="number"
                        [min]="pokemon.stats[stat.id].min()"
                        [max]="pokemon.stats[stat.id].max()"
                        [ngModel]="pokemon.stats[stat.id].get()"
                        (ngModelChange)="pokemon.stats[stat.id].set($event)"
                      />
                      <button
                        class="btn-reset"
                        (click)="pokemon.stats[stat.id].reset()"
                      >
                        Reset
                      </button>
                    </div>
                    <div class="stat-inputs-row">
                      <div class="input-group">
                        <label [for]="'stat-ev-' + $index" class="input-label"
                          >EVs</label
                        >
                        <input
                          [id]="'stat-ev-' + $index"
                          type="number"
                          [min]="0"
                          [max]="252"
                          [step]="getStep()"
                          class="input input-stat"
                          [(ngModel)]="pokemon!.stats[stat.id].evs"
                        />
                      </div>
                      <div class="input-group">
                        <label [for]="'stat-iv-' + $index" class="input-label"
                          >IVs</label
                        >
                        <input
                          [id]="'stat-iv-' + $index"
                          type="number"
                          [min]="0"
                          [max]="31"
                          class="input input-stat"
                          [(ngModel)]="pokemon!.stats[stat.id].ivs"
                        />
                      </div>
                      @if (stat.id === "hp") {
                        <span class="hp-rating">{{
                          hpRating(pokemon.stats[stat.id].get())
                        }}</span>
                      } @else {
                        <div class="nature-buttons">
                          <button
                            class="btn-nature btn-positive"
                            [class.active]="pokemon.nature.boost === stat.id"
                            (click)="setNature(stat.id, 'positive')"
                          >
                            +
                          </button>
                          <button
                            class="btn-nature btn-negative"
                            [class.active]="pokemon.nature.drop === stat.id"
                            (click)="setNature(stat.id, 'negative')"
                          >
                            -
                          </button>
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>
              <div class="teambuilder__section teambuilder__speedtier">
                <h2>Speed Tiers</h2>
                <div class="speedtier-list">
                  @for (tier of getSpeedTiers(); track $index) {
                    <div
                      class="speedtier-wrapper"
                      [class.dragging]="isDragging(tier)"
                      (dragstart)="onDragStart(tier, $event)"
                      (dragover)="onDragOver(tier, $event)"
                      (dragleave)="onDragLeave($event)"
                      (drop)="onDrop(tier, $event)"
                      (dragend)="onDragEnd()"
                    >
                      @if (shouldShowPlaceholder(tier) && draggedTier) {
                        <div class="speedtier speedtier-placeholder aTeam">
                          <div class="sprite-wrapper">
                            <pdz-sprite [pokemon]="draggedTier.pokemon" />
                          </div>
                          <div class="speed">
                            {{ tier.speed + 1 }}
                          </div>
                        </div>
                      }
                      <div
                        class="speedtier"
                        [class.aTeam]="tier.team === '0'"
                        [class.bTeam]="tier.team === '1'"
                        [class.draggable]="tier.team === '0'"
                        [class.dragging]="isDragging(tier)"
                        [attr.draggable]="tier.team === '0'"
                      >
                        <div class="sprite-wrapper">
                          <pdz-sprite [pokemon]="tier.pokemon" />
                        </div>
                        <div class="speed">
                          {{ tier.speed }}
                        </div>
                        <div class="modifiers">
                          @for (modifier of tier.modifiers; track $index) {
                            <span class="modifier">
                              {{ modifier }}
                            </span>
                          }
                        </div>
                      </div>
                    </div>
                  }
                </div>
              </div>
            </div>
          }
        }
      }
    </div>
  </div>
</div>
