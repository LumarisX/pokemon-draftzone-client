<section class="replay-analyzer">
  <h1 class="replay-analyzer__title">Replay Analyzer</h1>

  <div class="replay-analyzer__content">
    <div class="replay-analyzer__input-row">
      <label class="replay-analyzer__input-label" for="replay-uri"
        >Replay</label
      >
      <input
        id="replay-uri"
        [(ngModel)]="replayURI"
        type="url"
        class="replay-analyzer__input"
        inputmode="url"
        autocomplete="off"
        spellcheck="false"
      />
      <button
        type="button"
        (click)="analyze()"
        [disabled]="analyzed || !replayURI.trim()"
        class="replay-analyzer__analyze-button"
        [ngClass]="{
          'replay-analyzer__analyze-button--disabled':
            analyzed || !replayURI.trim(),
        }"
      >
        Analyze
      </button>
    </div>

    <div class="replay-analyzer__notice">
      The replay analyzer is currently still in testing. If you find errors,
      please share the replay on our
      <a
        href="https://discord.gg/sQUEBW4UVx"
        target="_blank"
        rel="noopener noreferrer"
        class="replay-analyzer__notice-link"
        >Discord</a
      >.
    </div>

    @if (replayData; as data) {
      <mat-card class="replay-analyzer__card">
        <div class="replay-analyzer__summary">
          <span class="replay-analyzer__summary-item">
            <label class="replay-analyzer__summary-label" for="format"
              >Format:</label
            >
            <span id="format">{{ data.gametype }}</span>
          </span>
          <span class="replay-analyzer__summary-item">
            <label class="replay-analyzer__summary-label" for="gen"
              >Generation:</label
            >
            <span id="gen">{{ data.genNum }}</span>
          </span>
          <span class="replay-analyzer__summary-item">
            <label class="replay-analyzer__summary-label" for="turns"
              >Turns:</label
            >
            <span id="turns">{{ data.turns }}</span>
          </span>
          <span class="replay-analyzer__summary-item">
            <label class="replay-analyzer__summary-label" for="game-time"
              >Game Time:</label
            >
            <span id="game-time"
              >{{ toMinutes(data.gameTime) }}m
              {{ remainingSeconds(data.gameTime) }}s</span
            >
          </span>
        </div>

        <mat-card-content class="replay-analyzer__details">
          <div class="replay-analyzer__players">
            @for (
              player of data.stats;
              track player.username ?? $index;
              let playerNum = $index
            ) {
              <div
                class="replay-analyzer__player"
                [ngClass]="playerClass(playerNum + 1)"
              >
                <div class="replay-analyzer__player-header">
                  <div class="replay-analyzer__player-name">
                    {{ player.username }}
                  </div>
                </div>

                <div class="replay-analyzer__player-layout">
                  <div class="replay-analyzer__player-stats">
                    <div class="replay-analyzer__stat-row">
                      <span class="replay-analyzer__stat-label">Kills:</span>
                      {{ player.total.kills }}
                    </div>
                    <mat-divider></mat-divider>

                    <div class="replay-analyzer__stat-row">
                      <span class="replay-analyzer__stat-label">Deaths:</span>
                      {{ player.total.deaths }}
                    </div>
                    <mat-divider></mat-divider>

                    <div class="replay-analyzer__stat-row">
                      <span class="replay-analyzer__stat-label"
                        >Damage Dealt:</span
                      >
                      {{ player.total.damageDealt | number: "1.0-0" }}%
                    </div>
                    <mat-divider></mat-divider>

                    <div class="replay-analyzer__stat-row">
                      <span class="replay-analyzer__stat-label"
                        >Damage Taken:</span
                      >
                      {{ player.total.damageTaken | number: "1.0-0" }}%
                    </div>
                    <mat-divider></mat-divider>

                    <div class="replay-analyzer__stat-row">
                      <span class="replay-analyzer__stat-label"
                        >Total Accuracy:</span
                      >
                      {{ player.luck.moves.actual | percent }} ({{
                        player.luck.moves.hits
                      }}/{{ player.luck.moves.total }})
                    </div>
                    <mat-divider></mat-divider>

                    <div class="replay-analyzer__stat-row">
                      <span class="replay-analyzer__stat-label"
                        >Expected Accuracy:</span
                      >
                      {{ player.luck.moves.expected | percent }}
                    </div>
                    <mat-divider></mat-divider>

                    <div class="replay-analyzer__stat-row">
                      <span class="replay-analyzer__stat-label"
                        >Total Crits:</span
                      >
                      {{ player.luck.crits.actual | percent }} ({{
                        player.luck.crits.hits
                      }}/{{ player.luck.crits.total }})
                    </div>
                    <mat-divider></mat-divider>

                    <div class="replay-analyzer__stat-row">
                      <span class="replay-analyzer__stat-label"
                        >Expected Crits:</span
                      >
                      {{ player.luck.crits.expected | percent }}
                    </div>
                    <mat-divider></mat-divider>

                    @if (player.luck.status.total > 0) {
                      <div class="replay-analyzer__stat-row">
                        <span class="replay-analyzer__stat-label"
                          >Total Fully Parad:</span
                        >
                        {{ player.luck.status.actual | percent }} ({{
                          player.luck.status.full
                        }}/{{ player.luck.status.total }})
                      </div>
                      <mat-divider></mat-divider>
                      <div class="replay-analyzer__stat-row">
                        <span class="replay-analyzer__stat-label"
                          >Expected Fully Parad:</span
                        >
                        {{ player.luck.status.expected | percent }}
                      </div>
                    }

                    @if (player.win) {
                      <div class="replay-analyzer__winner">Winner</div>
                    }
                  </div>

                  <div class="replay-analyzer__team">
                    @for (
                      mon of player.team;
                      track mon.formes[0]?.id ?? $index
                    ) {
                      <mat-card class="replay-analyzer__mon-card">
                        <mat-card-header
                          class="replay-analyzer__mon-card-header"
                        >
                          <mat-card-title
                            class="replay-analyzer__mon-card-title"
                          >
                            <pdz-sprite
                              title="{{ mon.formes[0].detail }}"
                              [pokemon]="{ id: mon.formes[0].id, name: '' }"
                              [disabled]="mon.fainted"
                            ></pdz-sprite>
                          </mat-card-title>
                        </mat-card-header>

                        <mat-card-content
                          class="replay-analyzer__mon-card-content"
                        >
                          <div class="replay-analyzer__mon-grid">
                            <div class="replay-analyzer__mon-stat-tile">
                              <span
                                class="replay-analyzer__stat-label replay-analyzer__stat-label--block"
                              >
                                Kills:
                              </span>
                              <mat-expansion-panel
                                disabled
                                hideToggle
                                class="replay-analyzer__compact-panel replay-analyzer__compact-panel--centered"
                                [matTooltip]="
                                  mon.kills[1]
                                    ? mon.kills[0] +
                                      ' direct, ' +
                                      mon.kills[1] +
                                      ' indirect'
                                    : ''
                                "
                              >
                                <mat-expansion-panel-header>
                                  <mat-panel-title
                                    class="replay-analyzer__panel-title replay-analyzer__panel-title--centered"
                                  >
                                    {{ mon.kills[0] + (mon.kills[1] || 0) }}
                                  </mat-panel-title>
                                </mat-expansion-panel-header>
                              </mat-expansion-panel>
                            </div>

                            <div class="replay-analyzer__mon-stat-tile">
                              <span
                                class="replay-analyzer__stat-label replay-analyzer__stat-label--block"
                              >
                                Deaths:
                              </span>
                              <mat-expansion-panel
                                disabled
                                hideToggle
                                class="replay-analyzer__compact-panel replay-analyzer__compact-panel--centered"
                              >
                                <mat-expansion-panel-header>
                                  <mat-panel-title
                                    class="replay-analyzer__panel-title replay-analyzer__panel-title--centered"
                                  >
                                    {{ mon.fainted ? 1 : 0 }}
                                  </mat-panel-title>
                                </mat-expansion-panel-header>
                              </mat-expansion-panel>
                            </div>
                          </div>

                          <div class="replay-analyzer__mon-section">
                            <span
                              class="replay-analyzer__stat-label replay-analyzer__stat-label--block replay-analyzer__stat-label--centered"
                            >
                              Damage Dealt:
                            </span>
                            <mat-accordion>
                              <mat-expansion-panel
                                class="replay-analyzer__compact-panel replay-analyzer__compact-panel--left"
                              >
                                <mat-expansion-panel-header>
                                  <mat-panel-title
                                    class="replay-analyzer__panel-title replay-analyzer__panel-title--left"
                                  >
                                    {{
                                      mon.damageDealt[0] +
                                        (mon.damageDealt[1] || 0)
                                        | number: "1.0-0"
                                    }}%
                                  </mat-panel-title>
                                </mat-expansion-panel-header>
                                <div>
                                  • Direct:
                                  {{ mon.damageDealt[0] | number: "1.0-0" }}%
                                </div>
                                @if (mon.damageDealt[1]) {
                                  <div>
                                    • Indirect:
                                    {{ mon.damageDealt[1] | number: "1.0-0" }}%
                                  </div>
                                }
                              </mat-expansion-panel>
                            </mat-accordion>
                          </div>

                          <div class="replay-analyzer__mon-section">
                            <span
                              class="replay-analyzer__stat-label replay-analyzer__stat-label--block replay-analyzer__stat-label--centered"
                            >
                              Damage Taken:
                            </span>
                            <mat-accordion>
                              <mat-expansion-panel
                                class="replay-analyzer__compact-panel replay-analyzer__compact-panel--left"
                              >
                                <mat-expansion-panel-header>
                                  <mat-panel-title
                                    class="replay-analyzer__panel-title replay-analyzer__panel-title--left"
                                  >
                                    {{
                                      mon.damageTaken[0] +
                                        (mon.damageTaken[1] || 0)
                                        | number: "1.0-0"
                                    }}%
                                  </mat-panel-title>
                                </mat-expansion-panel-header>
                                <div>
                                  • Direct:
                                  {{ mon.damageTaken[0] | number: "1.0-0" }}%
                                </div>
                                @if (mon.damageTaken[1]) {
                                  <div>
                                    • Indirect:
                                    {{ mon.damageTaken[1] | number: "1.0-0" }}%
                                  </div>
                                }
                              </mat-expansion-panel>
                            </mat-accordion>
                          </div>

                          <div
                            class="replay-analyzer__mon-stat-tile replay-analyzer__mon-stat-tile--centered"
                          >
                            <span
                              class="replay-analyzer__stat-label replay-analyzer__stat-label--block"
                            >
                              HP Restored:
                            </span>
                            <mat-expansion-panel
                              disabled
                              hideToggle
                              class="replay-analyzer__compact-panel"
                            >
                              <mat-expansion-panel-header>
                                <mat-panel-title
                                  class="replay-analyzer__panel-title"
                                >
                                  {{ mon.hpRestored | number: "1.0-0" }}%
                                </mat-panel-title>
                              </mat-expansion-panel-header>
                            </mat-expansion-panel>
                          </div>

                          @if (mon.moveset && mon.moveset.length > 0) {
                            <div class="replay-analyzer__mon-section">
                              <mat-accordion>
                                <mat-expansion-panel
                                  class="replay-analyzer__compact-panel"
                                >
                                  <mat-expansion-panel-header>
                                    <mat-panel-title
                                      class="replay-analyzer__panel-title"
                                    >
                                      Moveset:
                                    </mat-panel-title>
                                  </mat-expansion-panel-header>
                                  @for (move of mon.moveset; track move) {
                                    <div>• {{ move }}</div>
                                  }
                                </mat-expansion-panel>
                              </mat-accordion>
                            </div>
                          }
                        </mat-card-content>
                      </mat-card>
                    }
                  </div>
                </div>
              </div>
            }
          </div>

          <div class="replay-analyzer__events">
            <h2 class="replay-analyzer__events-title">Events</h2>
            <div class="replay-analyzer__events-list">
              @for (event of data.events; track $index) {
                <div
                  class="replay-analyzer__event"
                  [ngClass]="playerClass(event.player)"
                >
                  <span class="replay-analyzer__stat-label"
                    >Turn {{ event.turn }}:</span
                  >
                  {{ event.message }}
                </div>
              }
            </div>
          </div>

          <div class="replay-analyzer__chart-wrap">
            <pdz-replay-chart
              class="replay-analyzer__chart"
              [data]="data.stats"
            ></pdz-replay-chart>
          </div>
        </mat-card-content>
      </mat-card>
    }
  </div>
</section>
